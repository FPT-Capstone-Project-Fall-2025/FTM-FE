import { useEffect, useState } from "react";
import { Button, Checkbox, Input, Card, Space, Divider } from "antd";
import { PlusOutlined, UpOutlined, DownOutlined, CloseOutlined, EnvironmentOutlined } from "@ant-design/icons";
import { EVENT_TYPE_CONFIG, EVENT_TYPE } from "./EventTypeLabel";
import type { EventType } from "./EventTypeLabel";
import EventStatistics from "./EventStatistics";

/**
 * EventSidebar Component
 * 
 * Purpose: Left sidebar for Event page with filters and statistics
 * - Create new event button
 * - Event type filters (Ma chay, Cuoi hoi, Sinh nhat, Ngay)
 * - Family group filters
 * - Location filter
 * - Lunar calendar toggle
 * - Event statistics
 * 
 * Props:
 * - handleFilter: Function to update event filters
 * - setIsShowLunarDay: Toggle lunar calendar display
 * - setIsOpenGPEventDetailsModal: Open event creation modal
 * - setEventSelected: Set selected event
 */

interface EventSidebarProps {
  handleFilter: (filters: any) => void;
  setIsShowLunarDay: (value: boolean) => void;
  setIsOpenGPEventDetailsModal: (value: boolean) => void;
  setEventSelected: (value: any) => void;
}

// Mock data for demonstration
const MOCK_FAMILY_GROUPS = [
  { label: 'Gia phả họ Nguyễn', value: 'nguyen-family' },
  { label: 'Gia phả họ Trần', value: 'tran-family' },
  { label: 'Gia phả họ Lê', value: 'le-family' },
];

const MOCK_CITIES = [
  { name: 'Hồ Chí Minh', code: 'hcm', lat: 10.8231, lon: 106.6297 },
  { name: 'Hà Nội', code: 'hn', lat: 21.0285, lon: 105.8542 },
  { name: 'Đà Nẵng', code: 'dn', lat: 16.0544, lon: 108.2022 },
];

export default function EventSidebar({ 
  handleFilter, 
  setIsShowLunarDay, 
  setIsOpenGPEventDetailsModal, 
  setEventSelected 
}: EventSidebarProps) {
  // State management
  const [eventTypes, setEventTypes] = useState<EventType[]>([...Object.values(EVENT_TYPE)]);
  const [eventGroups, setEventGroups] = useState<string[]>([]);
  const [showLunar, setShowLunar] = useState(true);
  const [eventLocation, setEventLocation] = useState<string>("");
  const [openSections, setOpenSections] = useState({
    eventType: true,
    familyGroups: true,
  });

  // Toggle checkbox selection
  const toggleCheckbox = <T,>(list: T[], setList: (value: T[]) => void, value: T) => {
    setList(list.includes(value) ? list.filter((item) => item !== value) : [...list, value]);
  };

  // Toggle section open/close
  const toggleSection = (section: 'eventType' | 'familyGroups') => {
    setOpenSections((prev) => ({ ...prev, [section]: !prev[section] }));
  };

  useEffect(() => {
    handleFilter({eventType: eventTypes, eventGp: eventGroups, eventLocation: eventLocation});
  }, [eventTypes, eventGroups, eventLocation]);
  
  useEffect(() => {
    const fetchData = async () => {
      try {
        // Mock data for now - replace with actual API calls when services are available
        const mockGPData: GPItem[] = [];
        const mockCitiesData: any[] = [];

        setEventGp(mockGPData);

        const listCityMapped = mockCitiesData.map((x: any) => ({
          name: x.label,
          code: x.value,
          lat: x.lat,
          lon: x.lon,
        }));
        setListCity(listCityMapped);
        setInputValue("");
        setEventLocation("");
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    };

    fetchData();    
    setIsShowLunarDay(showLunar);
  }, []);

  const locationFilteredItems = listCity.filter((item) =>
    item.name.toLowerCase().includes(inputValue.toLowerCase())
  );

  const {
    isOpen,
    getInputProps,
    getMenuProps,
    getItemProps,
    highlightedIndex,
  } = useCombobox({
    items: locationFilteredItems,
    onInputValueChange: ({ inputValue }) => {
      setInputValue(inputValue || "")
      if (!inputValue) setEventLocation("");
    },
    onSelectedItemChange: ({ selectedItem }) => {
      if (selectedItem) {
        const found = listCity.find(x => x.code === selectedItem.code);
        setEventLocation(found || "");
      }
    },
    itemToString: (item) => (item ? item.name : ""),
  });

  return (
    <>
      <div className="w-100 pr-3 shadow-md">
        {/* Create Event Button */}
        <button className="btn-add-event" onClick={() => {
          setEventSelected(null);
          setIsOpenGPEventDetailsModal(true);
        }}>
          <span className="plus-icon">
            <span></span>
          </span>
          <span className="ml-2">Thêm sự kiện mới</span>
        </button>

        {/* Event Type Section */}
        <div className="mt-2">
          <span
            className="event-type"
            onClick={() => toggleSection("eventType")}
          >
            Loại sự kiện
            <span>{openSections.eventType ? <img className="px-1" src={ArrowUp} alt={ArrowUp} /> : <img className="px-1" src={ArrowDown} alt={ArrowDown} />}</span>
          </span>
          {openSections.eventType && (
            <div className="event-list">
              {Object.values(EVENT_TYPE).map((type) => (
                <label key={type} className={`${type}`}>
                  <Checkbox
                    checked={eventTypes.includes(type)}
                    onChange={() => toggleCheckbox(eventTypes, setEventTypes, type)}
                  >
                    <span><img className="px-1" src={EVENT_TYPE_CONFIG[type].icon} alt={EVENT_TYPE_CONFIG[type].icon} />
                      <span className={`event-type-text  ${type}`}>
                        {EVENT_TYPE_CONFIG[type].label}
                      </span>
                    </span>
                  </Checkbox>
                </label>
              ))}
            </div>
          )}
        </div>

        {/* Event List Section */}
        <div className="mt-2">
          <span
            className="event-type"
            onClick={() => toggleSection("eventList")}
          >
            Sự kiện gia phả
            <span>{openSections.eventList ? <img className="px-1" src={ArrowUp} alt={ArrowUp} /> : <img className="px-1" src={ArrowDown} alt={ArrowDown} />}</span>
          </span>
          {openSections.eventList && (
            <div className="event-list" style={{ maxHeight: "150px", overflowY: "auto" }}>
              {eventGp.map((group) => (
                <label key={group.value} className="checkbox-event">
                  <Checkbox
                    checked={eventGroups.includes(group.value)}
                    onChange={() => toggleCheckbox(eventGroups, setEventGroups, group.value)}
                  >
                    {group.label}
                  </Checkbox>
                </label>
              ))}
            </div>
          )}
        </div>

        {/* Show Lunar Year Section (Using Your Toggle Switch) */}
        <div className="mt-2">
          <div className="lunar-option">
            <span>Hiển thị lịch âm</span>
            <div className="toggle-container blue">
              <input
                className="toggle-checkbox"
                type="checkbox"
                checked={showLunar}
                onChange={() => {
                  setIsShowLunarDay(!showLunar);
                  setShowLunar(!showLunar);     
                }}
              />
              <div className="toggle-track">
                <div className="toggle-thumb"></div>
              </div>
            </div>
          </div>
        </div>
        <div className="mt-2">
          <span>Xem thời tiết theo vị trí địa lí</span>
        </div>
        <div className="event-location mt-2">
          <span><img className="px-1 mb-1" src={location} alt={location} /></span>
          <input
            {...getInputProps()}
            value={inputValue}
            placeholder="Nhập địa điểm..."
          />
          {inputValue && <button className="clear-btn" onClick={() => { setInputValue(""); setEventLocation("") }}><img src={Close} alt={Close} /></button>}
          {inputValue && isOpen && (
            <ul {...getMenuProps()} className="suggestion-list mt-1">
              {locationFilteredItems.map((item, index) => (
                <li
                  key={item.code}
                  {...getItemProps({
                    item,
                    index,
                    className: highlightedIndex === index ? "highlighted" : "",
                  })}
                >
                  {item.name}
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>
      <div className="w-100 pr-3 pt-3">
        <EventStatistics />
      </div>
    </>
  );
}